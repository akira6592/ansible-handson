[↑目次に戻る](./README.md)
<br>
# 演習3.4　IOS装置の設定情報をSmartCS経由で取得する

演習3.3でios_commandを使ってIOS装置から設定情報を取得するPlaybookを作成しました。    
作成したPlaybookの内容を一部変更して、SmartCS経由（コンソール経由）で同様の情報を取得するPlaybookを作成します。

## 目次
本演習では以下を行います。  
- [Step 1. ログイン用、ログアウト用のPlaybookを作成する](./3.4-setting_of_ios_device_via_smartcs.md#step-1-ログイン用ログアウト用のPlaybookを作成する)
- [Step 2. <code>ios_command</code>をSmartCS経由で動作させるように変更する](./3.4-setting_of_ios_device_via_smartcs.md#step-2-ios_commandをSmartCS経由で動作させるように変更する)
- [Step 3. 作成した3つのPlaybookを1回のコマンドで実行する](./3.4-setting_of_ios_device_via_smartcs.md#step-3-作成した3つのPlaybookを1回のコマンドで実行する) 

<br>
<br>

## 演習構成図

![practice_environment_3-4.png](./contents/image/practice_environment_3-4.png)

<br>
<br>

### Step 1. ログイン用、ログアウト用のPlaybookを作成する。

通常のモジュール(ios_command等)は、SSH経由で装置にログインして情報を取得しますが、コンソール経由で接続をする場合  
- コンソールからのログイン  
- コンソールからのログアウト  
の処理を行う必要があります。

演習3.1で使った<code>smartcs_tty_command</code>を利用してPlaybookを作成します。

<br>

■演習環境

![practice_environment_3-4_step1.png](./contents/image/practice_environment_3-4_step1.png)

<br>

■Playbookの編集箇所

| vars | Playbook例の値 | 備考 | 
|:---|:---|:---|
| tty_no |'1' | ユーザ毎に割り当てられているSmartCSの[**tty**番号](./1.1-preparing_for_the_exercise.md#コンソールサーバ--smartcs-)を指定します |

<br>


コンソール経由でのオペレーションは以下のような入出力となります。  
ログイン時
```
login: alaxala
Password:

Copyright (c) 2012-2019 ALAXALA Networks Corporation. All rights reserved.

AX2230>
```
ログアウト時
```
AX2230> exit

login:
```

Playbookは以下のような内容となります。  

■Playbook  
(console_login.yml)
```yaml
---
- name: Login from Console using SmartCS
  hosts: smartcs
  gather_facts: no
  
  vars:
  ### Variables that NEED to Change ###
  - tty_no: '1'
  
  ### Variables that should NOT change ###
  - ansible_connection: network_cli
  - ansible_network_os: smartcs
  - ansible_command_timeout: 60

  tasks:
  - name: login ax2230
    smartcs_tty_command:
      tty: '{{ tty_no }}'
      recvchar:
      - 'login: '
      - 'Password: '
      - 'AX2230>'
      sendchar:
      - 'alaxala'
      - 'secret2230'
```

(console_logout.yml)
```yaml
---
- name: Login from Console using SmartCS
  hosts: smartcs
  gather_facts: no
  
  vars:
  ### Variables that NEED to Change ###
  - tty_no: '1'
  
  ### Variables that should NOT change ###
  - ansible_connection: network_cli
  - ansible_network_os: smartcs
  - ansible_command_timeout: 60

  tasks:
  - name: logout ax2230
    smartcs_tty_command:
      tty: '{{ tty_no }}'
      recvchar:
      - 'login: '
      sendchar:
      - 'exit'
```

<br>
<br>

### Step 2. ios_commandをSmartCS経由で動作させるように変更する

実際の処理部分のPlaybookを作成します。  
演習3.3の<code>ios_command</code>とtask部分は同じですが、<code>hosts</code>に指定する値が変わります。

<br>

■演習環境

![practice_environment_3-4_step2.png](./contents/image/practice_environment_3-4_step2.png)

<br>


■Playbook(console_gathering_ios_information.yml)  
```yaml
---
- name: gathering ios informataion from console using SmartCS
  hosts: ios_sshxpt
  gather_facts: no

  tasks:
  - name: show commands
    cisco.ios.ios_command:
      commands:
        - show version
        - show interfaces gigabitethernet 0/1
        - show ip interface
        - show vlan 
        - show running-config
    register: result
  
  - name: show command output
    debug:
      msg:
        - '{{ result.stdout_lines[0] }}'
```
■Playbook内容の説明  
- <code>hosts: ios_sshxpt</code>  
SmartCS経由で接続を行うため、接続先をios_sshxptと設定します。   

<br>
<br>


### Step 3. 作成した3つのPlaybookを1回のコマンドで実行する 

STEP1、STEP2 で作成した3つのPlaybookを1回のコマンドで実行できるようなPlaybookを作成します。  
複数のPlaybookを集約して実行する際は、<code>import_playbook</code>を利用します。
https://docs.ansible.com/ansible/latest/modules/import_playbook_module.html

■Playbook(gathering_ios_information_via-console.yml)
```yaml
---
- name: login by console
  import_playbook: console_login.yml

- name: gathering ios information
  import_playbook: console_gathering_ios_information.yml

- name: logout by console
  import_playbook: console_logout.yml
```

■実行例
```
$ ansible-playbook -vvv gathering_ios_information_via-console.yml 
```

■実行結果例
```
PLAY [Login from Console using SmartCS] ******************************************************************

TASK [login ax2230] **************************************************************************************
ok: [smartcs]

PLAY [gathering ax informataion from console using SmartCS] **********************************************

TASK [show commands] *************************************************************************************
ok: [smartcs]

TASK [show command output] *******************************************************************************
ok: [smartcs] => {
    "msg": [
        [
            "Date 1980/05/02 05:31:23 UTC",
            "Model: AX2230S-24T",
            "S/W: OS-LT4 Ver. 2.9 (Build:04)",
            "H/W: AX-2230-24T-B [CA022B24T000S0000C7S013:0]"
        ]
    ]
}

PLAY [Login from Console using SmartCS] ******************************************************************

TASK [logout ax2230] *************************************************************************************
ok: [smartcs]

PLAY RECAP ***********************************************************************************************
smartcs                    : ok=4    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
```

SmartCS経由で`ios_command`を実行し、IOS装置のコマンド実行結果を取得することができました。  
ベンダーモジュールをSmartCS経由で動作させる場合、以下の変更をするだけでPlaybookを再利用する事が可能です。
※下記変更により、インベントリ内に記載されたベンダーモジュール連携用の`ansible_user`、`ansible_password`、`ansible_port`が適用されます。
- `hosts`を`ios`から`ios_sshxpt`に変更

<br>
<br>


## 演習3のまとめ

- <code>smartcs_tty_command</code>を使い、送受信する文字列を指定してコンソールアクセスをする方法  
- <code>ios_command</code>など、他ベンダーのモジュールを利用してSmartCS経由でPlaybookを実行する方法  
についての演習を行いました。  

AnsibleとSmartCSを連携してコンソールアクセスを行う方法としては上記の通り２パターンありますが、  
それぞれ一長一短があります。  

|| <code>smartcs_tty_command</code>を使う場合 | 他ベンダーモジュールとSmartCSを連携する場合 |
|:---|:---|:---|
|〇 |ベンダー製のモジュールの無いネットワーク機器にコンソール経由でアクセスすることが可能 |ベンダー製モジュールを使ったPlaybookの一部パラメータを変更する事でタスク部分は再利用が可能。|
|△ |コンソールの入出力情報がないと、Playbook作成ができない。冪等性の担保がない。 |<code>network_cli</code>コネクションプラグインをサポートしていないと使えない。処理時間がSSH経由と比較して長い |

ターゲットとなるネットワーク機器のベンダーモジュールがあり、コネクションプラグインとして<code>network_cli</code>をサポートしてる場合は、Playbookの再利用性などを考え、他ベンダーモジュールとSmartCSを連携して使う方法が望ましいです。

<code>smartcs_tty_command</code>を使うシチュエーションとして適切なのは以下のような場合となります。  
- ベンダー製モジュールが無いネットワーク機器にアクセスしたい場合  
- ベンダー製モジュールがあるが、<code>network_cli</code>プラグインのサポートないネットワーク機器にアクセスしたい場合
- 既存のモジュールを使ったオペレーションが難しい場合（再起動処理が含まれる手順など）

<br>
<br>

[→演習4.1 オペミスからの復旧自動化](./4.1-automation_of_operation_error_recovery.md)  
[←演習3.3 IOS装置の設定情報を取得する](./3.3-get_ios_device_information.md)   
[↑目次に戻る](./README.md)
